{% set GREEN = "#16A34A" %}
<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <title>{{ ev.title }} • AkwaabaTickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="icon" href="https://res.cloudinary.com/dglubbbfb/image/upload/v1755834123/logo_hlxw5e.png">

  <style>
    :root{ --brand: {{ GREEN }}; --line:#e5e7eb; --muted:#64748b; }
    .hero{ position:relative; border-bottom:1px solid var(--line); background:#fff; }
    .hero img{ width:100%; max-height:420px; object-fit:cover; }
    .pill{ background: rgba(22,163,74,.08); border:1px solid rgba(22,163,74,.25); color:#0f5132; }
    .cardish{ border:1px solid var(--line); border-radius:16px; background:#fff; }
    .btn-brand{ background:var(--brand); color:#fff; border:1px solid var(--brand); }
    .btn-outline-brand{ border:1px solid var(--brand); color:var(--brand); }
    .btn-outline-brand:hover{ background: rgba(22,163,74,.08); }
    .muted{ color: var(--muted); }
  </style>
</head>
<body class="bg-light">
    {% include "attendee_sidebar.html" %}


  <!-- Cover -->
  <section class="hero">
    <img src="{{ ev.cover }}" alt="Cover image for {{ ev.title }}">
  </section>

  <main class="container my-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, msg in messages %}
            <div class="alert alert-{{ 'success' if category=='success' else ('warning' if category=='warning' else 'danger') }} mb-2" role="alert">
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="row g-4">
      <!-- Left: details -->
      <div class="col-12 col-lg-8">
        <div class="mb-3 d-flex flex-wrap gap-2">
          {% for c in ev.categories %}
            <span class="badge rounded-pill pill">{{ (c or '')|replace('-', ' ')|title }}</span>
          {% endfor %}
        </div>

        <h1 class="h3">{{ ev.title }}</h1>
        <div class="text-muted d-flex flex-wrap gap-3">
          <span><i class="bi bi-calendar-event me-1"></i>{{ ev.when }}</span>
          <span><i class="bi bi-geo-alt me-1"></i>{{ ev.where }}</span>
        </div>

        {% if ev.starts_at and ev.ends_at %}
          <div class="mt-3">
            <div class="btn-group">
              <a class="btn btn-outline-brand" href="{{ url_for('public.event_ics', event_id=ev.id) }}">
                <i class="bi bi-calendar-plus"></i> Download .ics
              </a>
              <a class="btn btn-outline-brand" href="{{ gcal_url }}" target="_blank" rel="noopener">
                <i class="bi bi-google"></i> Google Calendar
              </a>
            </div>
          </div>
        {% endif %}

        <hr class="my-4">

        <article class="cardish p-3">
          <h2 class="h5 mb-3">About this event</h2>
          <div class="text-body">
            {{ ev.description | urlize | replace('\n', '<br>') | safe }}
          </div>
        </article>

        {% if ev.images and ev.images|length > 1 %}
          <section class="mt-4">
            <h2 class="h6 text-muted">Gallery</h2>
            <div class="row g-3">
              {% for img in ev.images[1:] %}
                <div class="col-6 col-md-4">
                  <img src="{{ img }}" alt="Event image" class="w-100 rounded-3 border">
                </div>
              {% endfor %}
            </div>
          </section>
        {% endif %}
      </div>

      <!-- Right: purchase -->
      <aside class="col-12 col-lg-4">
        <div class="cardish p-3">
          <h2 class="h5">Get Tickets</h2>
          {% if tiers %}
            {% set ns = namespace(checked_idx=None) %}
            <form method="get" action="{{ url_for('checkout.start') }}" class="mt-2" id="toCheckoutForm">
              <input type="hidden" name="event_id" value="{{ ev.id }}"/>

              <div class="vstack gap-2">
                {% for t in tiers %}
                  {# pick the first tier as default selection #}
                  {% if ns.checked_idx is none %}
                    {% set ns.checked_idx = t.idx %}
                  {% endif %}
                  <div class="border rounded-3 p-2">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="tier_idx"
                        id="tier{{ t.idx }}"
                        value="{{ t.idx }}"
                        {% if t.idx == ns.checked_idx %}checked{% endif %}
                        data-price="{{ '%.2f'|format(t.price or 0) }}"
                        data-max="{{ (t.per_order_limit if t.per_order_limit else (t.available if t.available else 999)) }}"
                        required
                      >
                      <label class="form-check-label w-100" for="tier{{ t.idx }}">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <strong>{{ t.name }}</strong>
                            {% if not t.sales_open %}
                              <span class="badge text-bg-secondary ms-2">Not on sale</span>
                            {% elif t.available <= 0 %}
                              <span class="badge text-bg-danger ms-2">Sold out</span>
                            {% endif %}
                            {% if t.refundable %}
                              <span class="badge text-bg-light border ms-2">Refundable</span>
                            {% endif %}
                          </div>
                          <div class="text-nowrap">
                            {% if t.price and t.price > 0 %}
                              <span class="fw-semibold">USDC {{ '%.2f'|format(t.price) }}</span>
                            {% else %}
                              <span class="fw-semibold">Free</span>
                            {% endif %}
                          </div>
                        </div>
                        <div class="small muted mt-1">
                          Available: {{ t.available }}{% if t.per_order_limit %} • Max per order: {{ t.per_order_limit }}{% endif %}
                        </div>
                      </label>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <!-- Quantity -->
              <div class="mt-3">
                <label for="qty" class="form-label">Quantity</label>
                <input id="qty" name="quantity" type="number" class="form-control" inputmode="numeric"
                       min="1" value="1">
                <div class="small text-muted mt-1" id="qtyHint"></div>
              </div>

              <!-- Live total -->
              <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="fw-semibold">Total (USDC)</span>
                <span class="fw-bold h5 mb-0" id="totalUSDC">0.00</span>
              </div>

              <button type="submit" class="btn btn-brand w-100 mt-3" id="checkoutBtn">
                <i class="bi bi-bag-check"></i> Proceed to checkout
              </button>
              <p class="small muted mt-2">You may be asked to log in before completing your purchase.</p>
            </form>
          {% else %}
            <p class="text-muted">No ticket tiers available.</p>
          {% endif %}
        </div>

        <div class="cardish p-3 mt-3">
          <h3 class="h6">Location</h3>
          <div class="text-muted">
            {% if ev.location.type == 'online' %}
              <i class="bi bi-wifi"></i> Online Event
            {% else %}
              <i class="bi bi-geo-alt"></i> {{ ev.location.venue_name or 'Venue TBA' }}<br>
              {{ ev.location.address or '' }} {{ ev.location.city or '' }}
            {% endif %}
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const radios = document.querySelectorAll('input[name="tier_idx"]');
      const qty = document.getElementById('qty');
      const total = document.getElementById('totalUSDC');
      const hint = document.getElementById('qtyHint');

      function currentTier() {
        for (const r of radios) if (r.checked) return r;
        return null;
      }

      function recompute() {
        const r = currentTier();
        if (!r) return;
        const price = parseFloat(r.getAttribute('data-price') || '0') || 0;
        const max = parseInt(r.getAttribute('data-max') || '999', 10) || 999;

        // keep qty within [1, max]
        const q = Math.min(Math.max(parseInt(qty.value || '1', 10) || 1, 1), max);
        qty.value = String(q);
        qty.max = String(max);
        hint.textContent = `Maximum for this tier: ${max}`;

        const sum = (price * q).toFixed(2);
        total.textContent = sum;
      }

      radios.forEach(r => r.addEventListener('change', recompute));
      qty.addEventListener('input', recompute);

      // initial
      recompute();
    })();
  </script>
  <script>
  window.cbConfig = {
    chatId: "0607a799-b5e6-484e-afb2-482ff18b5b4e"
  };
</script>
<script src="https://app.chatbit.co/embed.min.js" defer></script>
</body>
</html>
