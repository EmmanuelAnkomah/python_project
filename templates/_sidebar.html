<!-- Organizer Sidebar (Fixed on desktop, smooth drawer on mobile) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root{
    --brand:#16A34A; --brand-700:#0f6a31;
    --ink:#0b1b2b; --muted:#64748b; --line:#e5e7eb; --bg:#ffffff;
    --sidebar-w:264px; --sidebar-w-collapsed:72px; --radius:16px;
    --shadow:0 12px 32px rgba(2,6,23,.08);
    --sidebar-gap:12px;
  }

  /* Shift page content on desktop (so sidebar never overlays it) */
  @media (min-width: 992px){
    body { margin-left: calc(var(--sidebar-w) + var(--sidebar-gap)); }
    body[data-org-collapsed="true"] { margin-left: calc(var(--sidebar-w-collapsed) + var(--sidebar-gap)); }
  }

  /* Sidebar */
  .att-sidebar{
    position: fixed; inset: var(--sidebar-gap) auto var(--sidebar-gap) var(--sidebar-gap);
    width: var(--sidebar-w);
    background: var(--bg);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    display:flex; flex-direction:column; overflow:hidden;
    z-index: 1030;
    will-change: transform, width, opacity;
    transition:
      transform .32s cubic-bezier(.2,.8,.2,1),
      width .22s ease-in-out,
      opacity .22s ease-in-out;
  }
  .att-sidebar[data-collapsed="true"]{ width: var(--sidebar-w-collapsed); }

  /* Header + desktop toggle */
  .att-logo{ display:flex; align-items:center; gap:.6rem; padding:.75rem; border-bottom:1px solid var(--line); }
  .att-logo img{ width:32px; height:32px; border-radius:8px; }
  .att-logo .name{ font-weight:800; color:var(--ink); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .att-toggle-desktop{
    margin-left:auto;
    display:flex; align-items:center; gap:.4rem;
    padding:.35rem .55rem; border-radius:999px; border:1px solid var(--line);
    background:#fff; line-height:1; font-weight:600; color:#0f172a;
  }
  .att-toggle-desktop .bi{ transition: transform .22s ease; }
  .att-sidebar[data-collapsed="true"] .att-toggle-desktop .bi{ transform: rotate(180deg); }

  /* User */
  .att-user{ display:flex; align-items:center; gap:.6rem; padding:.75rem; border-bottom:1px solid var(--line); }
  .att-avatar, .att-avatar-img{
    width:36px; height:36px; border-radius:10px; background:#e9f7ef; display:grid; place-items:center; font-weight:700; color:var(--brand-700);
    object-fit:cover;
  }
  .att-user-info .who{ font-weight:700; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .att-user-info .role{ font-size:.82rem; color:var(--muted); }

  /* Nav */
  nav.att-nav{ padding:.5rem; overflow:auto; flex:1; }
  .att-nav ul{ list-style:none; margin:0; padding:0; }
  .att-nav .title{ color:var(--muted); font-size:.75rem; font-weight:700; letter-spacing:.04em; text-transform:uppercase; padding:.5rem .5rem .25rem; }

  .att-link{
    display:flex; align-items:center; gap:.75rem; width:100%; padding:.6rem .6rem; border-radius:12px; color:#0f172a; text-decoration:none;
    border:1px solid transparent; position:relative; transition: background .15s ease, color .15s ease, transform .15s ease;
  }
  .att-link .bi{ font-size:1.05rem; color:#475569; flex:0 0 auto; }
  .att-link:hover{ background:#f6fef8; transform: translateY(-1px); }
  .att-link.is-active{
    color:var(--brand-700); background:linear-gradient(180deg, rgba(22,163,74,.10), #fff);
    box-shadow: inset 0 0 0 1.5px rgba(22,163,74,.25);
  }
  .att-link.is-active::before{
    content:""; position:absolute; left:-.5rem; top:.35rem; bottom:.35rem; width:3px; border-radius:2px; background:var(--brand);
  }

  /* CTA */
  .att-cta{ position:sticky; bottom:0; background:#fff; border-top:1px solid var(--line); padding:.75rem; display:flex; gap:.5rem; }
  .btn-find{ border:1px solid var(--brand); color:#fff; background:var(--brand); border-radius:12px; padding:.5rem .75rem; width:100%; text-decoration:none; text-align:center; font-weight:600; }
  .btn-find:hover{ filter:brightness(.95); }

  /* Collapsed: hide labels */
  .att-sidebar[data-collapsed="true"] .name,
  .att-sidebar[data-collapsed="true"] .label,
  .att-sidebar[data-collapsed="true"] .att-user-info { display:none !important; }
  .att-sidebar[data-collapsed="true"] .att-link{ justify-content:center; padding:.6rem .45rem; }
  .att-sidebar[data-collapsed="true"] .att-link.is-active::before{ display:none; }

  /* Focus ring */
  .att-link:focus, .att-toggle-desktop:focus, .att-fab:focus{ outline: 3px solid rgba(22,163,74,.35); outline-offset: 2px; }

  /* Mobile drawer */
  @media (max-width: 991.98px){
    body, body[data-org-collapsed="true"] { margin-left: 0 !important; }
    .att-sidebar{
      transform: translateX(calc(-100% - var(--sidebar-gap))) scale(.98);
      opacity:.92; width: min(88vw, var(--sidebar-w));
    }
    .att-sidebar[data-open="true"]{ transform: translateX(0) scale(1); opacity:1; }
    .att-backdrop{
      position:fixed; inset:0; background: rgba(2,6,23,.35); backdrop-filter: blur(3px);
      opacity:0; pointer-events:none; transition: opacity .28s cubic-bezier(.2,.8,.2,1); z-index: 1029;
    }
    .att-backdrop[data-open="true"]{ opacity:1; pointer-events:auto; }
    .att-fab{
      position: fixed; left:14px; bottom:16px; z-index:1031;
      display:inline-flex; align-items:center; gap:.5rem; border:none; border-radius:999px; padding:.7rem .9rem;
      background: var(--brand); color:#fff; box-shadow: 0 12px 24px rgba(22,163,74,.35);
      transform: translateZ(0); transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
    }
    .att-fab:active{ transform: scale(.98); box-shadow: 0 8px 18px rgba(22,163,74,.28); }
    .att-fab[aria-expanded="true"]{ opacity:.85; }
    .att-toggle-desktop{ display:none; }
  }
</style>

<!-- Sidebar -->
<aside id="orgSidebar" class="att-sidebar" data-collapsed="false" role="navigation" aria-label="Organizer">
  <div class="att-logo">
    <img src="https://res.cloudinary.com/dglubbbfb/image/upload/v1755834123/logo_hlxw5e.png" alt="Logo">
    <span class="name">AkwaabaTickets</span>
    <button id="orgCollapse" class="att-toggle-desktop" type="button" aria-label="Collapse sidebar" title="Collapse">
      <i class="bi bi-chevron-left"></i>
      <span class="d-none d-xl-inline">Hide</span>
    </button>
  </div>

  <div class="att-user" aria-label="User">
    {% if session.get('avatar_url') or (me and me.avatar_url) %}
      <img class="att-avatar-img" src="{{ session.get('avatar_url') or me.avatar_url }}" alt="Avatar">
    {% else %}
      <div class="att-avatar">{{ (name or session.get('name') or 'O')[:1]|upper }}</div>
    {% endif %}
    <div class="att-user-info">
      <div class="who">{{ name or session.get('name') or 'Organizer' }}</div>
      <div class="role">Organizer</div>
    </div>
  </div>

  <nav class="att-nav" id="orgNav">
    <div class="title">Overview</div>
    <ul>
      <li>
        <a class="att-link {{ 'is-active' if request.path.startswith('/organizer/dashboard') else '' }}"
           href="{{ url_for('organizer.dashboard') }}"
           data-bs-toggle="tooltip" data-bs-placement="right" title="Dashboard"
           aria-current="{{ 'page' if request.path.startswith('/organizer/dashboard') else 'false' }}">
          <i class="bi bi-speedometer2"></i><span class="label">Dashboard</span>
        </a>
      </li>
    </ul>

    <div class="title mt-2">Manage</div>
    <ul>
      <li>
        <a class="att-link {{ 'is-active' if request.path.startswith('/organizer/events') and not request.path.endswith('/new') else '' }}"
           href="/organizer/events"
           data-bs-toggle="tooltip" data-bs-placement="right" title="Events"
           aria-current="{{ 'page' if request.path.startswith('/organizer/events') and not request.path.endswith('/new') else 'false' }}">
          <i class="bi bi-calendar-event"></i><span class="label">Events</span>
        </a>
      </li>
      <li>
        <a class="att-link {{ 'is-active' if request.path.endswith('/events/new') else '' }}"
           href="{{ url_for('organizer.events_new') }}"
           data-bs-toggle="tooltip" data-bs-placement="right" title="Create Event"
           aria-current="{{ 'page' if request.path.endswith('/events/new') else 'false' }}">
          <i class="bi bi-plus-square"></i><span class="label">Create Event</span>
        </a>
      </li>
      <li>
        <a class="att-link {{ 'is-active' if request.path.startswith('/organizer/tickets') else '' }}"
           href="/organizer/tickets"
           data-bs-toggle="tooltip" data-bs-placement="right" title="Tickets"
           aria-current="{{ 'page' if request.path.startswith('/organizer/tickets') else 'false' }}">
          <i class="bi bi-ticket-perforated"></i><span class="label">Tickets</span>
        </a>
      </li>
      <li>
        <a class="att-link {{ 'is-active' if request.path.startswith('/organizer/attendees') else '' }}"
           href="/organizer/attendees"
           data-bs-toggle="tooltip" data-bs-placement="right" title="Attendees"
           aria-current="{{ 'page' if request.path.startswith('/organizer/attendees') else 'false' }}">
          <i class="bi bi-people"></i><span class="label">Attendees</span>
        </a>
      </li>
    </ul>

    <div class="title mt-2">Account</div>
    <ul>
      <li>
  <a class="att-link {{ 'is-active' if request.path.startswith('/organizer/profile') else '' }}"
     href="{{ url_for('organizer.organizer_profile_view') }}"
     data-bs-toggle="tooltip" data-bs-placement="right" title="Profile"
     aria-current="{{ 'page' if request.path.startswith('/organizer/profile') else 'false' }}">
    <i class="bi bi-person-gear"></i><span class="label">Profile</span>
  </a>
</li>

      <li>
        <a class="att-link {{ 'is-active' if request.path.startswith('/organizer/settings') else '' }}"
           href=""
           data-bs-toggle="tooltip" data-bs-placement="right" title="Settings"
           aria-current="{{ 'page' if request.path.startswith('/organizer/settings') else 'false' }}">
          <i class="bi bi-gear"></i><span class="label">Settings</span>
        </a>
      </li>
      <li>
        <a class="att-link"
           href="{{ url_for('login.login') }}"
           data-bs-toggle="tooltip" data-bs-placement="right" title="Log out">
          <i class="bi bi-box-arrow-right"></i><span class="label">Log out</span>
        </a>
      </li>
    </ul>
  </nav>

  <div class="att-cta">
    <a class="btn-find" href="{{ url_for('organizer.events_new') }}">
      <i class="bi bi-plus-lg"></i> <span class="label">New Event</span>
    </a>
  </div>
</aside>

<!-- Backdrop for mobile drawer -->
<div id="orgBackdrop" class="att-backdrop" aria-hidden="true"></div>

<!-- Mobile FAB trigger -->
<button id="orgFab" class="att-fab d-lg-none" type="button" aria-controls="orgSidebar" aria-expanded="false">
  <i class="bi bi-list"></i><span>Menu</span>
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  const sidebar  = document.getElementById('orgSidebar');
  const collapse = document.getElementById('orgCollapse');
  const fab      = document.getElementById('orgFab');
  const backdrop = document.getElementById('orgBackdrop');
  const nav      = document.getElementById('orgNav');

  // Persist collapsed state (desktop) + shift content
  const KEY = 'organizer-sidebar-collapsed';
  const saved = localStorage.getItem(KEY);
  if (saved === 'true') setCollapsed(true);

  function setCollapsed(flag){
    sidebar.setAttribute('data-collapsed', flag ? 'true' : 'false');
    document.body.setAttribute('data-org-collapsed', flag ? 'true' : 'false');
    localStorage.setItem(KEY, String(flag));
    collapse?.setAttribute('aria-label', flag ? 'Expand sidebar' : 'Collapse sidebar');
    collapse?.setAttribute('title', collapse.getAttribute('aria-label') || '');
    toggleTooltips(flag);
  }
  collapse?.addEventListener('click', ()=> setCollapsed(sidebar.getAttribute('data-collapsed') !== 'true'));

  // Drawer open/close (mobile)
  function setDrawer(open){
    sidebar.setAttribute('data-open', open ? 'true' : 'false');
    backdrop?.setAttribute('data-open', open ? 'true' : 'false');
    backdrop?.setAttribute('aria-hidden', open ? 'false' : 'true');
    fab?.setAttribute('aria-expanded', open ? 'true' : 'false');
    document.body.style.overflow = open ? 'hidden' : '';
  }
  fab?.addEventListener('click', ()=> setDrawer(sidebar.getAttribute('data-open') !== 'true'));
  backdrop?.addEventListener('click', ()=> setDrawer(false));
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && sidebar.getAttribute('data-open') === 'true') setDrawer(false); });

  // Keyboard nav in menu
  const focusables = () => Array.from(nav.querySelectorAll('a.att-link'));
  nav.addEventListener('keydown', (e)=>{
    if(!['ArrowDown','ArrowUp'].includes(e.key)) return;
    e.preventDefault();
    const f = focusables();
    const idx = f.indexOf(document.activeElement);
    if (e.key === 'ArrowDown'){ (f[idx+1] || f[0])?.focus(); }
    else { (f[idx-1] || f[f.length-1])?.focus(); }
  });

  // Tooltips only when collapsed
  let tooltipList = [];
  function toggleTooltips(enable){
    tooltipList.forEach(t => t.dispose());
    tooltipList = [];
    if (!enable) return;
    const tEls = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipList = tEls.map(el => new bootstrap.Tooltip(el, {trigger:'hover focus'}));
  }
  toggleTooltips(sidebar.getAttribute('data-collapsed') === 'true');

  // Ensure drawer closes if viewport grows to desktop
  const mq = window.matchMedia('(min-width: 992px)');
  mq.addEventListener?.('change', (e)=>{ if (e.matches) setDrawer(false); });
})();
</script>
