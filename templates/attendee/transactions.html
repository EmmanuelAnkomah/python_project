{% set GREEN = "#16A34A" %}
<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <title>My Transactions • AkwaabaTickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="https://res.cloudinary.com/dglubbbfb/image/upload/v1755834123/logo_hlxw5e.png">

  <style>
    :root { --brand: {{ GREEN }}; --line:#e5e7eb; --muted:#64748b; }
    .cardish{ border:1px solid var(--line); border-radius:16px; background:#fff; box-shadow:0 12px 32px rgba(2,6,23,.04); }
    .btn-brand{ background:var(--brand); color:#fff; border:1px solid var(--brand); }
    .btn-brand:hover{ filter:brightness(.95); }
    .badge-soft{ background:rgba(22,163,74,.08); color:var(--brand); border:1px solid rgba(22,163,74,.2); }
    .table th{ white-space:nowrap; }
    .table td{ vertical-align:middle; }
  </style>
</head>
<body class="bg-light">
  {% include "attendee_sidebar.html" %}

  <main class="container my-4">
    <div class="row g-4">
      <div class="col-12 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
        <h1 class="h5 mb-0">My Transactions</h1>
        <div class="text-muted small">
          Total: <strong>{{ vm.total }}</strong> • Sum: <strong>{{ '%.2f'|format(vm.sum_amount) }} {{ vm.rows[0].currency if vm.rows else 'USDC' }}</strong>
        </div>
      </div>

      <div class="col-12">
        <div class="cardish p-3">
          <form class="row gy-2 gx-2">
            <div class="col-12 col-md-3">
              <input class="form-control" name="q" placeholder="Search tx hash / payment id / event" value="{{ vm.filters.q }}">
            </div>
            <div class="col-6 col-md-2">
              <select class="form-select" name="status">
                <option value="">All status</option>
                {% for s in ["paid","onchain_confirmed","refunded"] %}
                  <option value="{{ s }}" {% if vm.filters.status==s %}selected{% endif %}>{{ s|capitalize }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-6 col-md-2">
              <select class="form-select" name="kind">
                <option value="">All kinds</option>
                {% for k in ["ticket_purchase","refund","airdrop"] %}
                  <option value="{{ k }}" {% if vm.filters.kind==k %}selected{% endif %}>{{ k.replace("_"," ")|capitalize }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-6 col-md-2">
              <select class="form-select" name="chain_id">
                <option value="">All chains</option>
                {% for cid, meta in vm.net_opts.items() %}
                  <option value="{{ cid }}" {% if vm.filters.chain_id==cid %}selected{% endif %}>{{ meta.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-6 col-md-1"><input type="date" class="form-control" name="from" value="{{ vm.filters.from }}"></div>
            <div class="col-6 col-md-1"><input type="date" class="form-control" name="to" value="{{ vm.filters.to }}"></div>
            <div class="col-6 col-md-1">
              <select class="form-select" name="per">
                {% for n in [10,20,50,100] %}
                  <option value="{{ n }}" {% if vm.filters.per==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-auto">
              <button class="btn btn-brand w-100">Filter</button>
            </div>
            <div class="col-12 col-md-auto">
              <a class="btn btn-outline-secondary w-100" href="{{ url_for('attendee_tx.export_csv', **vm.filters) }}">Export CSV</a>
            </div>
          </form>
        </div>
      </div>

      <div class="col-12">
        <div class="cardish p-0">
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Kind</th>
                  <th>Event</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Amount</th>
                  <th>Chain</th>
                  <th>Status</th>
                  <th>Links</th>
                </tr>
              </thead>
              <tbody>
                {% if vm.rows %}
                  {% for r in vm.rows %}
                  <tr>
                    <td class="small text-nowrap">{{ (r.created_at or '') and r.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
                    <td><span class="badge text-bg-light border">{{ r.kind.replace("_"," ")|capitalize }}</span></td>
                    <td>
                      <div class="fw-semibold">{{ r.event_title }}</div>
                      {% if r.tier_index is not none %}<div class="small text-muted">Tier #{{ r.tier_index + 1 }}</div>{% endif %}
                    </td>
                    <td class="text-end">{{ r.quantity }}</td>
                    <td class="text-end">USDC {{ '%.2f'|format(r.amount) }}</td>
                    <td>
                      <div>{{ r.chain_name }}</div>
                      <div class="small text-muted">{{ r.chain_id }}</div>
                    </td>
                    <td>
                      {% set s = (r.base_status or '') %}
                      {% if s == 'paid' %}
                        <span class="badge badge-soft">Paid</span>
                      {% elif s == 'onchain_confirmed' %}
                        <span class="badge text-bg-warning">On‑chain</span>
                      {% elif s == 'refunded' %}
                        <span class="badge text-bg-danger">Refunded</span>
                      {% else %}
                        <span class="badge text-bg-secondary">{{ s or '—' }}</span>
                      {% endif %}
                    </td>
                    <td class="small">
                      {% if r.tx_link %}
                        <a href="{{ r.tx_link }}" target="_blank" rel="noopener">Tx</a>
                      {% else %}
                        <span class="text-muted">Tx —</span>
                      {% endif %}
                      {% if r.base_payment_id %}
                        <span class="ms-2" title="Base Payment ID">{{ r.base_payment_id[:6] }}…</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="8" class="text-center py-5 text-muted">No transactions yet.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-between align-items-center p-3">
            <div class="small text-muted">Page {{ vm.page }} of {{ vm.pages }}</div>
            <nav aria-label="Transactions pages">
              <ul class="pagination mb-0">
                {% set args = vm.filters.copy() %}
                {% set prev_p = vm.page - 1 %}
                {% set next_p = vm.page + 1 %}
                <li class="page-item {% if vm.page <= 1 %}disabled{% endif %}">
                  {% set _ = args.update({'page': 1}) %}
                  <a class="page-link" href="{{ url_for('attendee_tx.transactions', **args) }}">&laquo;</a>
                </li>
                <li class="page-item {% if vm.page <= 1 %}disabled{% endif %}">
                  {% set _ = args.update({'page': prev_p}) %}
                  <a class="page-link" href="{{ url_for('attendee_tx.transactions', **args) }}">Prev</a>
                </li>
                <li class="page-item {% if vm.page >= vm.pages %}disabled{% endif %}">
                  {% set _ = args.update({'page': next_p}) %}
                  <a class="page-link" href="{{ url_for('attendee_tx.transactions', **args) }}">Next</a>
                </li>
                <li class="page-item {% if vm.page >= vm.pages %}disabled{% endif %}">
                  {% set _ = args.update({'page': vm.pages}) %}
                  <a class="page-link" href="{{ url_for('attendee_tx.transactions', **args) }}">&raquo;</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>

    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
