<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Organizer Dashboard â€” AkwaabaTickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
      <link rel="icon" href="https://res.cloudinary.com/dglubbbfb/image/upload/v1755834123/logo_hlxw5e.png">

  <style>
    :root{
      --brand:#16A34A; --brand-700:#0f6a31;
      --ink:#0b1b2b; --muted:#64748b; --line:#e5e7eb; --bg:#f8fafc;
      --radius:16px;
    }
    body{ background: var(--bg); color: var(--ink); }
    .page{ padding: clamp(12px, 3vw, 24px); }
    .card-soft{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(2,6,23,.06);
      background: #fff;
    }
    .stat{
      display:flex; gap:14px; align-items:center;
      padding:18px; border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(22,163,74,.10), rgba(22,163,74,.02));
      border: 1px solid rgba(22,163,74,.15);
    }
    .stat .icon{
      width:48px; height:48px; border-radius:12px;
      display:grid; place-items:center; font-size:22px;
      color:#fff; background: var(--brand);
      box-shadow: 0 8px 20px rgba(22,163,74,.4);
    }
    .stat h6{ margin:0; color: var(--muted); font-weight:600; }
    .stat .value{ font-size: clamp(20px, 3.2vw, 28px); font-weight:800; }
    .section-title{ font-weight:800; font-size: clamp(18px, 2.2vw, 22px); }
    .link-muted{ color: var(--muted); text-decoration: none; }
    .chip{
      display:inline-block; padding:.25rem .6rem; border-radius:999px;
      border:1px solid var(--line); background:#fff; font-size:.8rem;
    }
    .brand-pill{
      background: var(--brand); color:#fff; border-radius:999px; padding:.4rem .7rem; font-weight:700;
    }
    .table > :not(caption) > * > * { padding:.75rem 1rem; }
    .table thead th{ color: var(--muted); font-weight:700; text-transform: uppercase; font-size:.78rem; }
    .btn-brand{
      background: var(--brand); color:#fff; border:none; border-radius:10px; padding:.55rem .9rem;
    }
    .btn-brand:hover{ background: var(--brand-700); color:#fff; }
  </style>
</head>
<body>
  {% include "_sidebar.html" %}

  <main class="page">
    <!-- Header -->
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-3">
      <div>
        <h2 class="fw-bold mb-1">Welcome back, {{ vm.name }} ðŸ‘‹</h2>
        <div class="text-secondary">Hereâ€™s your organizer overview at a glance.</div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="brand-pill"><i class="bi bi-lightning-fill me-1"></i> AkwaabaTickets</span>
        <a href="{{ url_for('organizer.dashboard') }}" class="btn btn-light border">Refresh</a>
      </div>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat h-100">
          <div class="icon"><i class="bi bi-calendar2-check"></i></div>
          <div>
            <h6>Total Events</h6>
            <div class="value">{{ vm.stats.total_events }}</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat h-100">
          <div class="icon"><i class="bi bi-calendar-event"></i></div>
          <div>
            <h6>Upcoming</h6>
            <div class="value">{{ vm.stats.upcoming_events }}</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat h-100">
          <div class="icon"><i class="bi bi-ticket-perforated"></i></div>
          <div>
            <h6>Tickets Sold</h6>
            <div class="value">{{ vm.stats.tickets_sold }}</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat h-100">
          <div class="icon"><i class="bi bi-cash-coin"></i></div>
          <div>
            <h6>Revenue (USDC)</h6>
            <div class="value">{{ '%.2f'|format(vm.stats.revenue or 0.0) }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart + Upcoming -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-lg-8">
        <div class="card-soft p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">Ticket Sales â€” Last 14 Days</div>
            <span class="chip"><i class="bi bi-graph-up-arrow me-1"></i> Performance</span>
          </div>
          <div style="height:300px">
            <canvas id="salesChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card-soft p-3 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">Upcoming Events</div>
            <span class="chip"><i class="bi bi-calendar4-week me-1"></i> Next 5</span>
          </div>
          {% if vm.upcoming %}
          <ul class="list-group list-group-flush">
            {% for e in vm.upcoming %}
            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div class="me-3">
                <div class="fw-bold">{{ e.title }}</div>
                <div class="small text-secondary">
                  {% if e.starts_at %}{{ e.starts_at.strftime('%a, %b %d Â· %H:%M UTC') }}{% else %}TBA{% endif %}
                </div>
              </div>
              <a class="btn btn-sm btn-brand" href="{{ url_for('public.event_profile', event_id=e.id) }}">
                <i class="bi bi-box-arrow-in-right"></i>
              </a>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-secondary">No upcoming events found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="card-soft p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="section-title">Recent Activity</div>
        <span class="chip"><i class="bi bi-clock-history me-1"></i> Latest 8</span>
      </div>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th style="min-width:140px;">When</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Event</th>
              <th>TX / Status</th>
            </tr>
          </thead>
          <tbody>
            {% if vm.recent %}
            {% for r in vm.recent %}
            <tr>
              <td>{% if r.created_at %}{{ r.created_at.strftime('%Y-%m-%d %H:%M UTC') }}{% else %}â€”{% endif %}</td>
              <td class="text-capitalize"><i class="bi bi-activity me-1 text-success"></i>{{ r.kind.replace('_',' ') }}</td>
              <td>{% if r.amount is not none %}{{ '%.2f'|format(r.amount) }} {{ r.currency or 'USDC' }}{% else %}â€”{% endif %}</td>
              <td>
                {% if r.event_id %}
                  <a class="link-muted" href="{{ url_for('public.event_profile', event_id=r.event_id) }}"><i class="bi bi-box-arrow-up-right me-1"></i>Open</a>
                {% else %}â€”{% endif %}
              </td>
              <td class="small">
                {% if r.tx_hash %}
                  <span class="text-truncate d-inline-block" style="max-width:180px;"><i class="bi bi-fingerprint me-1"></i>{{ r.tx_hash }}</span>
                {% elif r.base_status %}
                  <span class="badge text-bg-success-subtle border border-success-subtle"><i class="bi bi-check2-circle me-1"></i>{{ r.base_status }}</span>
                {% else %}â€”{% endif %}
              </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr><td colspan="5" class="text-secondary">No recent activity yet.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Inject chart data safely without globals -->
  <script id="chart-data" type="application/json">
    {{ vm.chart|tojson }}
  </script>

  <!-- Self-contained chart initializer; no global variables -->
  <script>
    (function initSalesChart(){
      // Wait for Chart.js (defer-loaded)
      if (typeof Chart === "undefined") {
        document.addEventListener("DOMContentLoaded", initSalesChart);
        return;
      }
      try {
        const el = document.getElementById('chart-data');
        const payload = el ? JSON.parse(el.textContent || '{}') : {};
        const lbls = Array.isArray(payload.labels) ? payload.labels : [];
        const dataSeries = Array.isArray(payload.series) ? payload.series : [];

        const canvas = document.getElementById('salesChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 220);
        gradient.addColorStop(0, 'rgba(22,163,74,0.35)');
        gradient.addColorStop(1, 'rgba(22,163,74,0.02)');

        // eslint-disable-next-line no-new
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: lbls,
            datasets: [{
              label: 'Tickets',
              data: dataSeries,
              tension: 0.35,
              fill: true,
              backgroundColor: gradient,
              borderColor: '#16A34A',
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (c) => ` ${c.parsed.y} tickets` } }
            },
            scales: {
              x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 7 }, grid: { display: false } },
              y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,.05)' } }
            }
          }
        });
      } catch(e) {
        console.error('Chart init failed:', e);
      }
    })();
  </script>
  <script>
  window.cbConfig = {
    chatId: "0607a799-b5e6-484e-afb2-482ff18b5b4e"
  };
</script>
<script src="https://app.chatbit.co/embed.min.js" defer></script>
</body>
</html>
